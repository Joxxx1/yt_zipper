#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
è‡ªåŠ¨è·å–YouTube cookiesçš„Pythonè„šæœ¬
æ”¯æŒä»Chromeã€Firefoxã€Edgeç­‰æµè§ˆå™¨è·å–cookies
"""

import os
import sys
import time
from pathlib import Path

def check_browser_cookie3():
    """æ£€æŸ¥æ˜¯å¦å®‰è£…äº†browser_cookie3åº“"""
    try:
        import browser_cookie3
        return True
    except ImportError:
        print("âŒ æœªå®‰è£…browser_cookie3åº“")
        print("ğŸ’¡ è¯·è¿è¡Œ: pip install browser_cookie3")
        return False

def get_chrome_cookies():
    """ä»Chromeæµè§ˆå™¨è·å–cookies"""
    try:
        import browser_cookie3
        
        print("ğŸ” æ­£åœ¨ä»Chromeæµè§ˆå™¨è·å–cookies...")
        cookies = browser_cookie3.chrome(domain_name='.youtube.com')
        
        if not cookies:
            print("âš ï¸ æœªæ‰¾åˆ°YouTube cookiesï¼Œè¯·ç¡®ä¿å·²ç™»å½•YouTube")
            return False
        
        return export_cookies(cookies, "Chrome")
        
    except Exception as e:
        print(f"âŒ ä»Chromeè·å–cookieså¤±è´¥: {e}")
        return False

def get_firefox_cookies():
    """ä»Firefoxæµè§ˆå™¨è·å–cookies"""
    try:
        import browser_cookie3
        
        print("ğŸ” æ­£åœ¨ä»Firefoxæµè§ˆå™¨è·å–cookies...")
        cookies = browser_cookie3.firefox(domain_name='.youtube.com')
        
        if not cookies:
            print("âš ï¸ æœªæ‰¾åˆ°YouTube cookiesï¼Œè¯·ç¡®ä¿å·²ç™»å½•YouTube")
            return False
        
        return export_cookies(cookies, "Firefox")
        
    except Exception as e:
        print(f"âŒ ä»Firefoxè·å–cookieså¤±è´¥: {e}")
        return False

def get_edge_cookies():
    """ä»Edgeæµè§ˆå™¨è·å–cookies"""
    try:
        import browser_cookie3
        
        print("ğŸ” æ­£åœ¨ä»Edgeæµè§ˆå™¨è·å–cookies...")
        cookies = browser_cookie3.edge(domain_name='.youtube.com')
        
        if not cookies:
            print("âš ï¸ æœªæ‰¾åˆ°YouTube cookiesï¼Œè¯·ç¡®ä¿å·²ç™»å½•YouTube")
            return False
        
        return export_cookies(cookies, "Edge")
        
    except Exception as e:
        print(f"âŒ ä»Edgeè·å–cookieså¤±è´¥: {e}")
        return False

def export_cookies(cookies, browser_name):
    """å¯¼å‡ºcookiesåˆ°æ–‡ä»¶"""
    try:
        # åˆ›å»ºcookies.txtæ–‡ä»¶
        with open('cookies.txt', 'w', encoding='utf-8') as f:
            f.write('# Netscape HTTP Cookie File\n')
            f.write('# https://curl.se/rfc/cookie_spec.html\n')
            f.write(f'# This file was generated by get_cookies.py from {browser_name}\n')
            f.write(f'# Generated at: {time.strftime("%Y-%m-%d %H:%M:%S")}\n\n')
            
            cookie_count = 0
            for cookie in cookies:
                # æ£€æŸ¥æ˜¯å¦æ˜¯YouTubeç›¸å…³çš„cookie
                if 'youtube.com' in cookie.domain or 'google.com' in cookie.domain:
                    f.write(f'{cookie.domain}\tTRUE\t{cookie.path}\t'
                           f'{"TRUE" if cookie.secure else "FALSE"}\t{cookie.expires}\t'
                           f'{cookie.name}\t{cookie.value}\n')
                    cookie_count += 1
        
        print(f"âœ… æˆåŠŸå¯¼å‡º {cookie_count} ä¸ªcookiesåˆ°cookies.txt")
        print(f"ğŸ“ æ–‡ä»¶ä½ç½®: {os.path.abspath('cookies.txt')}")
        return True
        
    except Exception as e:
        print(f"âŒ å¯¼å‡ºcookieså¤±è´¥: {e}")
        return False

def verify_cookies_file():
    """éªŒè¯cookies.txtæ–‡ä»¶"""
    try:
        if not os.path.exists('cookies.txt'):
            print("âŒ cookies.txtæ–‡ä»¶ä¸å­˜åœ¨")
            return False
        
        with open('cookies.txt', 'r', encoding='utf-8') as f:
            content = f.read()
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        file_size = os.path.getsize('cookies.txt')
        if file_size < 100:
            print("âš ï¸ cookies.txtæ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½ä¸åŒ…å«æœ‰æ•ˆcookies")
            return False
        
        # æ£€æŸ¥æ˜¯å¦åŒ…å«YouTubeç›¸å…³cookies
        if 'youtube.com' in content:
            print("âœ… cookies.txtæ–‡ä»¶æ ¼å¼æ­£ç¡®")
            print("âœ… åŒ…å«YouTube cookies")
            print(f"ğŸ“Š æ–‡ä»¶å¤§å°: {file_size} å­—èŠ‚")
            return True
        else:
            print("âš ï¸ cookies.txtæ–‡ä»¶å¯èƒ½ä¸åŒ…å«YouTube cookies")
            return False
            
    except Exception as e:
        print(f"âŒ éªŒè¯å¤±è´¥: {e}")
        return False

def show_manual_guide():
    """æ˜¾ç¤ºæ‰‹åŠ¨è·å–æŒ‡å—"""
    print("\nğŸ“– æ‰‹åŠ¨è·å–cookiesæŒ‡å—:")
    print("1. å®‰è£…æµè§ˆå™¨æ‰©å±• 'Get cookies.txt LOCALLY'")
    print("2. è®¿é—® https://www.youtube.com å¹¶ç™»å½•")
    print("3. ç‚¹å‡»æ‰©å±•å›¾æ ‡å¯¼å‡ºcookies")
    print("4. å°†å¯¼å‡ºçš„æ–‡ä»¶é‡å‘½åä¸º cookies.txt")
    print("5. æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•")
    print("\nğŸ’¡ è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹ COOKIES_SETUP_GUIDE.md")

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸª YouTube Cookiesè·å–å·¥å…·")
    print("=" * 40)
    
    # æ£€æŸ¥ä¾èµ–
    if not check_browser_cookie3():
        show_manual_guide()
        return
    
    print("\nğŸ“‹ è¯·é€‰æ‹©æµè§ˆå™¨:")
    print("1. Chrome (æ¨è)")
    print("2. Firefox")
    print("3. Edge")
    print("4. æ‰‹åŠ¨è·å–æŒ‡å—")
    print("5. éªŒè¯ç°æœ‰cookies.txtæ–‡ä»¶")
    print("6. é€€å‡º")
    
    while True:
        choice = input("\nè¯·é€‰æ‹© (1-6): ").strip()
        
        if choice == "1":
            if get_chrome_cookies():
                verify_cookies_file()
            break
        elif choice == "2":
            if get_firefox_cookies():
                verify_cookies_file()
            break
        elif choice == "3":
            if get_edge_cookies():
                verify_cookies_file()
            break
        elif choice == "4":
            show_manual_guide()
            break
        elif choice == "5":
            verify_cookies_file()
            break
        elif choice == "6":
            print("ğŸ‘‹ é€€å‡ºç¨‹åº")
            break
        else:
            print("âŒ æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡æ–°è¾“å…¥")
    
    print("\nğŸ’¡ æç¤º:")
    print("- cookies.txtæ–‡ä»¶å·²åˆ›å»ºï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨ä¸‹è½½å™¨")
    print("- å¦‚æœä¸‹è½½å¤±è´¥ï¼Œè¯·é‡æ–°è·å–cookies")
    print("- å»ºè®®æ¯å‘¨æ›´æ–°ä¸€æ¬¡cookiesæ–‡ä»¶")
    print("- ä¸è¦åˆ†äº«æ‚¨çš„cookies.txtæ–‡ä»¶")

if __name__ == "__main__":
    main()
